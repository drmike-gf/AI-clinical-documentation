name: Build & Deploy medical-transcribe

on:
  push:
    branches: [ "main" ]
    paths:
      - "apps/medical-transcribe/**"
      - "infra/scripts/**"
      - ".github/workflows/build-deploy-medical-transcribe.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      PROJECT_ID: automations-n8n-463018
      REGION: us-central1
      IMAGE_REGION: us-central1
      SERVICE: medical-transcribe
      AR_REPO: us-central1-docker.pkg.dev/automations-n8n-463018/audio-pipelines
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA }}
          # optional but handy:
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform

      - uses: google-github-actions/setup-gcloud@v2
      
      - name: Build & push image (no Cloud Build bucket)
        run: |
          gcloud auth configure-docker $IMAGE_REGION-docker.pkg.dev -q
          IMAGE="$AR_REPO/$SERVICE:${GITHUB_SHA::7}"
          docker build -t "$IMAGE" "apps/${SERVICE}"
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy Cloud Run
        run: |
          gcloud run deploy $SERVICE \
            --image="${IMAGE}" \
            --region=$REGION \
            --no-allow-unauthenticated \
            --service-account=audio-prep-sa@${PROJECT_ID}.iam.gserviceaccount.com \
            --set-env-vars=PROJECT_ID=${PROJECT_ID},REGION=global,OUTPUT_BUCKET=phi-output-encounters,OUTPUT_PREFIX=transcripts/,PREPPED_BUCKET=phi-inbound-audio-raw,PREPPED_PREFIX=prepped/,SPEECH_MODEL=medical_conversation

      # Optional: ensure the trigger exists in 'us'
      - name: Ensure Eventarc trigger
        run: |
          bash infra/scripts/create-eventarc-trigger.sh
